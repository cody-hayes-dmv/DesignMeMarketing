generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  AGENCY
  WORKER
}

enum AgencyRole {
  WORKER
  MANAGER
  OWNER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum Status {
  ACTIVE
  PENDING
  REJECTED
}

enum TokenType {
  EMAIL_VERIFY // email confirmation after agency self-registers
  INVITE // invite link (agency or worker)
  MAGIC_LOGIN // passwordless one-time login for workers
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email        String  @unique
  name         String?
  passwordHash String? // agency users set this at registration; workers optionally later
  role         Role    @default(AGENCY)
  verified     Boolean @default(false) // must confirm email before login (self-registered agencies)
  invited      Boolean @default(false) // true if created from an invite

  // Memberships to agencies (owner/worker)
  memberships UserAgency[]

  // Clients
  clients Client[]

  // Emails & login tokens
  tokens Token[]

  // Tasks assigned (optional)
  assignedTaksks Task[] @relation("TaskAssignee")
  createdTass    Task[] @relation("TaskCreator")

  @@map("users")
}

model Agency {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name      String
  subdomain String? @unique // e.g., acme â†’ acme.yourseodashboard.com

  // Memberships (owner(s) and workers)
  members UserAgency[]

  // Works
  tasks Task[]

  // Tokens for invitations
  tokens Token[]

  // Onboarding templates
  onboardingTemplates OnboardingTemplate[]

  @@map("agencies")
}

model UserAgency {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  agencyId String
  agency   Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Per-agency role (owner/manager/worker). Use Role.AGENCY here for owners/managers in MVP.
  agencyRole AgencyRole @default(WORKER)

  @@unique([userId, agencyId])
  @@index([agencyId])
  @@index([userId])
  @@map("user_agencies")
}

model Task {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title          String
  description    String?
  category       String?
  dueDate        DateTime?
  status         TaskStatus @default(TODO)
  priority       String? // "high", "medium", "low"
  estimatedHours Int?
  
  // Proof/Attachments: Array of objects with type (image/video/url) and value (file URL or URL string)
  // Example: [{ type: "image", value: "https://...", name: "screenshot.png" }, { type: "url", value: "https://example.com" }]
  proof Json? @db.Json

  // Tenant scope
  agencyId String
  agency   Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Who created it (agency owner/worker/admin)
  createdById String?
  createdBy   User?   @relation("TaskCreator", fields: [createdById], references: [id], onDelete: SetNull)

  // Who it's assigned to
  assigneeId String?
  assignee   User?   @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  // who it is for
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  @@index([agencyId, status])
  @@index([assigneeId])
  @@map("tasks")
}

model Token {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  usedAt    DateTime?

  type      TokenType
  email     String // the email this token is for
  token     String    @unique @db.VarChar(500) // in prod: store a hash instead of raw token
  expiresAt DateTime

  // Optional scoping
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id], onDelete: SetNull)

  role Role? // target role for INVITE (AGENCY/WORKER)

  metadata Json? @db.Json

  @@index([type, email])
  @@map("tokens")
}

model Client {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name     String  @unique
  domain   String  @unique
  industry String?
  targets  Json?   @db.Json
  status   Status  @default(PENDING)

  // Login credentials for workers
  loginUrl String?
  username String?
  password String?
  notes    String?

  userId String
  user   User   @relation(fields: [userId], references: [id])
  Task   Task[]

  // SEO Data
  seoReports SeoReport[]
  keywords   Keyword[]
  backlinks  Backlink[]
  rankedKeywordsHistory RankedKeywordsHistory[]
  topPages   TopPage[]
  trafficSources TrafficSource[]
  backlinkTimeseries BacklinkTimeseries[]
  targetKeywords TargetKeyword[]

  @@index([name, domain])
  @@map("clients")
}

model SeoReport {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Report metadata
  reportDate DateTime
  period     String // "daily", "weekly", "monthly"

  // Traffic metrics
  totalSessions    Int
  organicSessions  Int
  paidSessions     Int
  directSessions   Int
  referralSessions Int

  // SEO metrics
  totalClicks      Int
  totalImpressions Int
  averageCtr       Float
  averagePosition  Float

  // Engagement metrics
  bounceRate         Float
  avgSessionDuration Float
  pagesPerSession    Float

  // Conversion metrics
  conversions    Int
  conversionRate Float

  // Client relationship
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, reportDate, period])
  @@index([clientId, reportDate])
  @@map("seo_reports")
}

model Keyword {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  keyword      String
  searchVolume Int
  difficulty   Float?
  cpc          Float?
  competition  String?

  // Ranking data
  currentPosition  Int?
  previousPosition Int?
  bestPosition     Int?

  // Google SERP data
  googleUrl     String? // The URL that ranks for this keyword
  serpFeatures  Json?   // Array of SERP features (e.g., ["video", "images", "local_pack"])
  totalResults  Int?    // Total number of search results

  // Performance data
  clicks      Int   @default(0)
  impressions Int   @default(0)
  ctr         Float @default(0)

  // Client relationship
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, keyword])
  @@index([clientId, currentPosition])
  @@map("keywords")
}

model RankedKeywordsHistory {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Total keywords ranked for the domain
  totalKeywords Int

  // Client relationship
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Month and year for tracking
  month Int // 1-12
  year  Int

  @@unique([clientId, month, year])
  @@index([clientId, year, month])
  @@map("ranked_keywords_history")
}

model Backlink {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sourceUrl    String
  targetUrl    String
  anchorText   String?
  domainRating Float?
  urlRating    Float?
  traffic      Int?
  isFollow     Boolean   @default(true)
  isLost       Boolean   @default(false)
  firstSeen    DateTime?
  lastSeen     DateTime?

  // Client relationship
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, isLost])
  @@index([clientId, domainRating])
  @@map("backlinks")
}

model OnboardingTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String
  description String?
  isDefault   Boolean @default(false)

  // Agency relationship
  agencyId String
  agency   Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Template tasks
  tasks OnboardingTask[]

  @@index([agencyId])
  @@map("onboarding_templates")
}

model OnboardingTask {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title          String
  description    String?
  category       String?
  priority       String? // "high", "medium", "low"
  estimatedHours Int?
  order          Int     @default(0)

  // Template relationship
  templateId String
  template   OnboardingTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId, order])
  @@map("onboarding_tasks")
}

model TopPage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  url String

  // Organic metrics
  organicPos1    Int @default(0)
  organicPos2_3  Int @default(0)
  organicPos4_10 Int @default(0)
  organicCount   Int @default(0)
  organicEtv     Float @default(0)
  organicIsNew   Int @default(0)
  organicIsUp    Int @default(0)
  organicIsDown  Int @default(0)
  organicIsLost  Int @default(0)

  // Paid metrics
  paidCount Int @default(0)
  paidEtv   Float @default(0)

  // Raw API data for reference
  rawData Json? @db.Json

  // Client relationship
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, url])
  @@index([clientId, organicEtv])
  @@map("top_pages")
}

model TrafficSource {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name  String // "Organic", "Direct", "Referral", "Paid", "Other"
  value Float  @default(0)

  // Aggregated metrics
  totalKeywords        Int @default(0)
  totalEstimatedTraffic Float @default(0)
  organicEstimatedTraffic Float @default(0)
  averageRank          Float?
  rankSampleSize       Int @default(0)

  // Client relationship
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, name])
  @@index([clientId])
  @@map("traffic_sources")
}

model BacklinkTimeseries {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  date DateTime

  newBacklinks            Int @default(0)
  lostBacklinks           Int @default(0)
  newReferringDomains     Int @default(0)
  lostReferringDomains    Int @default(0)
  newReferringMainDomains Int @default(0)
  lostReferringMainDomains Int @default(0)

  // Raw API data for reference
  rawData Json? @db.Json

  // Client relationship
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, date])
  @@index([clientId, date])
  @@map("backlink_timeseries")
}

model TargetKeyword {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  keyword       String
  searchVolume  Int?
  cpc           Float?
  competition   String?
  competitionValue Float?
  monthlySearches Json? @db.Json // Array of monthly search volumes for past 12 months
  keywordInfo   Json? @db.Json // Additional keyword information from API
  
  // Location and language
  locationCode  Int?
  locationName  String?
  languageCode  String?
  languageName  String?
  
  // SERP data
  serpInfo      Json? @db.Json // Full SERP info object from API
  serpItemTypes Json? @db.Json // Array of SERP feature types
  googleUrl     String? // URL that ranks for this keyword
  googlePosition Int? // Current Google ranking position
  previousPosition Int? // Previous ranking position for change calculation
  seResultsCount String? // Number of search results
  
  // Client relationship
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, keyword])
  @@index([clientId, searchVolume])
  @@index([clientId, googlePosition])
  @@map("target_keywords")
}
